define("left-pad",["module"],function(a){"use strict";a.exports=c;var b=[""," ","  ","   ","    ","     ","      ","       ","        ","         "];function c(a,c,d){a=a+"";c=c-a.length;if(c<=0)return a;if(!d&&d!==0)d=" ";d=d+"";if(d===" "&&c<10)return b[c]+a;var e="";while(true){if(c&1)e+=d;c>>=1;if(c)d+=d;else break}return e+a}});var __importDefault=this&&this.__importDefault||function(a){return a&&a.__esModule?a:{default:a}};define("push-manager",["require","exports","Emitter","Promise","RPC","left-pad","jquery"],function(require,exports,a,b,c,d){"use strict";a=__importDefault(a);b=__importDefault(b);c=__importDefault(c);d=__importDefault(d);var e;var f=["push_title","push_body","push_icon","locale","account","application","client_name"];var g=(new Date).getTimezoneOffset()/60*-1;var h=g>0?"+":"-";var i="GMT"+h+d.default(Math.abs(g),2,0)+"00";var j={};j.setup=function a(b){e=b;for(var c=0;c<f.length;c++){if(typeof e[f[c]]!=="string"){throw new Error("Module push-manager not configured: "+f[c]+".")}}j._accounts=[e.account]};j.SUBSCRIBE_NOTAVAIL=1;j.SUBSCRIBE_YES=2;j.SUBSCRIBE_NO=3;j._subscribeStatus=[j.SUBSCRIBE_WAIT];j._subsribtionId=null;j._settingsDefault={state:j.SUBSCRIBE_WAIT,settings:{filterFolders:[],filterTime:"09:00-22:00",clientTZ:i}};j._settings=[$.extend({},j._settingsDefault)];j.isSupport=function a(){if(!("serviceWorker"in window.navigator)){return false}if(!("showNotification"in window.ServiceWorkerRegistration.prototype)){return false}if(j.isBlocked()){return false}if(!("PushManager"in window)){return false}try{if(String(window.navigator.userAgent).match(/.*\sGecko\/.*Firefox\/.*/)){return false}}catch(a){}try{if(String(window.navigator.userAgent).match(/.*\sOPR\/\d.*/)){if(!String(window.navigator.userAgent).match(/.*\sMobile\sSafari.*/)){return false}}}catch(a){}return true};var k=$.Deferred();j.register=function a(b,c){if(this.isSupport()){navigator.serviceWorker.register(b,c).then(k.resolve,k.reject)}else{k.reject()}return this.waitRegister()};j.waitRegister=function a(){return k.promise()};j.isPayload=function a(){if(!j.isSupport()){return false}var b;try{b=navigator.userAgent.match(/Chrome\/(\d*)/)}catch(a){}if(b&&b.length&&b[1]){var c=parseInt(b[1],10);if(c>=51){return true}}return false};j.checkStatus=function a(){return new b.default(function(a,b){if(j.isSupport()){navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription()}).then(function(b){a(!!b)},b)}else{b()}})};j.isBlocked=function a(){if(!window.Notification||window.Notification.permission==="denied"){return true}else{return false}};j._checkSubscribe=function a(){j._subscribeStatus[0]=j.SUBSCRIBE_WAIT;return navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription()}).then(function(a){var b="";if(a){j._subscribeStatus[0]=j.SUBSCRIBE_YES;b=a.subscriptionId||a.endpoint.match(/.*\/(.*)/)[1];j._setSubscriptionId(b)}else{j._subscribeStatus[0]=j.SUBSCRIBE_NO}return j._subscribeStatus[0]},function(){return b.default.reject(j._subscribeStatus[0]=j.SUBSCRIBE_NOTAVAIL)})};j._setSubscriptionId=function a(b){j._subsribeId=b};j.fetchStatus=function a(c){c=$.extend({reset:false},c);var d;var e=false;for(var f=0;f<this._settings.length;f++){if(this._settings[f].state===j.SUBSCRIBE_WAIT){e=true}}if(!j.isSupport()){d=b.default.reject(new Error("Push notifications not available"))}else if(!c.reset&&!e){d=b.default.resolve(j._settings)}else{d=j._checkSubscribe().then(j._fetchSettings)}return d};j.multiAuth=function a(b){for(var c=0;c<b.length;c++){if(this._accounts.indexOf(b[c])==-1){this._accounts.push(b[c]);this._settings.push($.extend({},this._settingsDefault))}}return this._accounts};j.saveSettings=function a(c){var d=$.extend({},this._settings[0].settings),e=$.extend({},this._settings[0].settings,c);var f=e.filterFolders.map(parseFloat);var g=[];for(var h=0;h<f.length;h++){if(g.indexOf(f[h])==-1){g.push(f[h])}}e.filterFolders=g;j._settings[0].settings=e;return j._subscribe().then(function(){return true},function(a){j._settings[0].settings=d;return b.default.reject(a)})};j._requests=[];j._request=function a(d,f){return new b.default(function(a,b){if(j._subsribeId){c.default.post("messages/pushnotifications/settings",{account:d,application:e.application,subscription_id:j._subsribeId,platform:f}).then(function(b){a(b.body)},function(c){if(c.body&&c.body["subscription_id"]&&c.body["subscription_id"].error=="not_exists"){a({})}else{b(c)}})}else{a({})}})};j._fetchSettings=function a(c,d){var e;if(!d){d={}}d.platform=d.platform||(j.isPayload()?"webpush":"android");if(j._requests.length===0){for(var f=0;f<j._accounts.length;f++){var g=j._accounts[f];j._requests.push(j._request(g,d.platform))}}e=b.default.all.call(this,j._requests).then(function(a){for(var b=0;b<a.length;b++){var c=[],d="";try{c=a[b].settings.capabilities.can_mail.Filter.Folder.filterList}catch(a){}try{d=a[b].settings.capabilities.can_mail.PushDeliveryTimeRange||""}catch(a){}j._settings[b].state=a[b].account?j.SUBSCRIBE_YES:j.SUBSCRIBE_NO;j._settings[b].settings={filterFolders:c,filterTime:d,clientTZ:i}}j._requests=[];return j._settings},function(){j._requests=[];return b.default.reject("Get settings error")});return e.then(function(a){return j._settings})};j.toggleSubscribe=function a(b){return j.fetchStatus().then(function(a){var b=a[0].state===j.SUBSCRIBE_YES;return b?j._unsubscribe():j._subscribe()})};j._saveServiceWorkerAccounts=function a(b){var c=[];for(var d=0;d<j._settings.length;d++){if(j._settings[d].state===j.SUBSCRIBE_YES){c.push(j._accounts[d])}}b.active.postMessage(JSON.stringify({type:"pushManagerAccounts",body:c}));return c};j._saveSettings=function a(d){var f=d.subscriptionId||d.endpoint.match(/.*\/(.*)/)[1];var g=[];for(var h=0;h<j._accounts.length;h++){var i=j._accounts[h];if(j._settings[h].state===j.SUBSCRIBE_YES){var k={};var l="android";if(j.isPayload()){try{k=JSON.parse(JSON.stringify(d)).keys}catch(a){}l="webpush"}else{k=undefined}g.push({token:f,platform:l,status:0,account:j._accounts[h],application:e.application,settings:{webpush_keys:k,capabilities:{can_mail:{Filter:{Folder:{filterList:j._settings[h].settings.filterFolders,enabled:true}},PushDeliveryTimeRange:j._settings[h].settings.filterTime},chrome_mode:1},badge:{status:false},ClientTimeZone:j._settings[h].settings.clientTZ,device_id:f,client:{lang:e.locale,name:e.client_name,type:"Smartphone"}}})}}return new b.default(function(a,b){if(g.length){c.default.post("messages/pushnotifications/settings/edit",{subscriptions:JSON.stringify(g)}).then(function(b){a(b.body)},b)}else{a()}})};j._subscribe=function a(){return navigator.serviceWorker.ready.then(function(a){return a.pushManager.subscribe({userVisibleOnly:true})}).then(function(a){j._settings[0].state=j.SUBSCRIBE_YES;return j._saveSettings(a).then(function(a){j._subscribeStatus[0]=j.SUBSCRIBE_YES;navigator.serviceWorker.ready.then(function(a){j._saveServiceWorkerAccounts(a)});return a})["catch"](function(a){j._settings[0].state=j.SUBSCRIBE_NO})})};j._unsubscribe=function a(){return navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription()}).then(function(a){j._settings[0].state=j.SUBSCRIBE_NO;j._subscribeStatus[0]=j.SUBSCRIBE_NO;return j._saveSettings(a).then(function(c){return navigator.serviceWorker.ready.then(function(c){var d=j._saveServiceWorkerAccounts(c);return a&&d.length===0?a.unsubscribe():b.default.resolve()})})}).then(function(){return j._checkSubscribe()})};j._migrateToPushWithPayload=function a(b){j._checkSubscribe().then(function(a){if(!j.isPayload()){b(false);return null}switch(a){case j.SUBSCRIBE_YES:var d=function(a,b){if(a()){b()}else{setTimeout(function(){d(a,b)},100)}};var e=function(){d(function(){return c.default.setup().baseUrl!="//api.mail.ru/"},function(){j._fetchSettings(undefined,{platform:"android"}).then(function(){j.saveSettings().then(function(){b(true)},function(){b(false)})},function(){b(false)})})};if(typeof __PH!="undefined"&&__PH.loadAccountsList){__PH.loadAccountsList(function(a){var b=[];for(var c=0;c<a.accounts.length;c++){b.push(a.accounts[c].email)}j.multiAuth(b);e()})}else{e()}break;default:b(true);break}})};j._onPostMessage=function a(b){try{var c=JSON.parse(b.data);if(c&&c.type==="needPushManagerMigrate"&&c.body){if(c.body.to===2){j._migrateToPushWithPayload(function(a){var d=JSON.stringify({type:"failPushManagerMigrate",body:{from:c.body.from,to:c.body.to}});if(a){d=JSON.stringify({type:"donePushManagerMigrate",body:{from:c.body.from,to:c.body.to}})}b.source.postMessage(d)})}}}catch(a){}};if(j.isSupport()){navigator.serviceWorker.ready.then(function(a){var b=["push_title","push_title_plural","push_body","push_body_plural","push_icon","locale","application","client_name","counter_push_version","counter_push_click","counter_push_show","push_empty_subject","push_from","push_to"];var c={};for(var d=0;d<b.length;d++){c[b[d]]=e[b[d]]}var f=JSON.stringify({type:"pushManagerConfig",body:c});var g;if(j.isPayload()){g=JSON.stringify({type:"pushManagerMigrate",body:{version:2}})}if(a.active){a.active.postMessage(f);g&&a.active.postMessage(g)}if(a.waiting){a.waiting.postMessage(f);g&&a.waiting.postMessage(g)}if(a.installing){a.installing.addEventListener("statechange",function(a){if(a.target.state==="installed"){a.target.postMessage(f);g&&a.target.postMessage(g)}})}navigator.serviceWorker.addEventListener("message",j._onPostMessage)})}a.default.apply(j);exports.default=j;return j});define("push-manager/push-manager",["push-manager"],function(a){return a});